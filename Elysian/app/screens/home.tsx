/* 
File: home.tsx
Function: This is the Home screen component for the app where the recommendations generated by the AI engine will display.
*/

import React, { useState } from 'react';
import { View, ScrollView, ActivityIndicator } from 'react-native';
import { Text, Button, Card} from 'react-native-paper';
import { useNavigation } from '@react-navigation/native';
import { NativeStackNavigationProp } from '@react-navigation/native-stack';
import { styles } from './app_styles.styles';

// Define the navigation parameter list
export type RootParamList = {
  Home: undefined;
};

// Define the type for Home screen navigation prop
type HomeScreenProp = NativeStackNavigationProp<RootParamList, 'Home'>;

// Home component
const Home = () => {
  // Initialize navigation with type safety
  const navigation = useNavigation<HomeScreenProp>();
  const [loading, setLoading] = useState(false);
  const [recommendations, setRecommendations] = useState<any[]>([]);
  const fetchRecommendations = async () => {
    setLoading(true); // Show a loading screen waiting for the recommendations.
    try { // First, we will fetch the recommendations hosted page and then post the vectorized input data for the specific user.
      const response = await fetch('https://capstone-team-generated-group30-project.onrender.com/recommend', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query_vector: [3, 1, 2, 0, 4, 2, 1, 0, 1, 0] // Example input: 6 categorical + 4 vacation flags
        }),
      });

      const data = await response.json(); // Once we have given the data, it will run the hosted app.py to generate recommendations from the model.
      setRecommendations(data.recommendations || []); // Get the recommendations, otherwise return empty.
    } catch (error) {
      console.error('Error fetching recommendations:', error);
    } finally {
      setLoading(false); // Once recommendations are received, we can stop the loading screen.
    }
  };

  return (
    <ScrollView contentContainerStyle={[styles.container, { flexGrow: 1 }]}>
      <Text variant="headlineLarge" style={styles.title}>Your Adventure Starts Here!</Text>
      {/* This is a button that will call to the fetchRecommendations to get a JSON of the recommendations.*/}
      <Button mode="contained" onPress={fetchRecommendations} style={{ marginTop: 20 }}>
        Get Recommendations
      </Button>

      {loading && <ActivityIndicator size="large" style={{ marginTop: 20 }} />}
      {/* This is where we display all the recommendations received from the model. */}
      {recommendations.length > 0 && (
        <View style={{ marginTop: 30 }}>
          <Text variant="titleMedium" style={{ marginBottom: 10 }}>Top Cities:</Text>
          {recommendations.map((city) => (
            <Card key={city.city_id} style={{ marginBottom: 15, padding: 15 }}>
              <Text variant="titleSmall">{city.city_name}, {city.country}</Text>
              <Text>Score: {city.score.toFixed(2)}</Text>
            </Card>
          ))}
        </View>
      )}
    </ScrollView>
  );
};

export default Home;
